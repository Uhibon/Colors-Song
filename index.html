<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Colors Video — Fun FX</title>
<style>
  :root { --card-max-w: 92vw; --card-max-h: 92svh; }
  body {
    margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: #e6f2ff; min-height: 100svh; display: grid; place-items: center;
    overflow: hidden; padding-bottom: env(safe-area-inset-bottom);
  }
  .wrap {
    width: min(1000px, var(--card-max-w)); max-height: var(--card-max-h);
    background: rgba(255,255,255,.95); border-radius: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.15);
    padding: 12px 14px 16px; box-sizing: border-box; display: grid; gap: 12px;
    grid-template-rows: auto 1fr auto auto; /* status, video, controls, fx */
  }
  .row { display: flex; gap: 8px; align-items: center; justify-content: center; flex-wrap: wrap; }
  .btn {
    appearance: none; border: 0; padding: 10px 12px; border-radius: 12px;
    background: #0b61ff; color: #fff; font-weight: 700; cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,.15);
  }
  .btn:active { transform: translateY(1px); }
  .btn.ghost { background: #edf3ff; color: #0b61ff; }
  .btn.pink { background: #ff6ec7; }
  .chip { padding: 8px 10px; border-radius: 999px; background: #eef5ff; color: #05367e; font-weight: 700; }
  .small { font-size: .9rem; color: #05367e; font-weight: 600; }
  input[type="range"] { width: 240px; }
  video {
    width: 100%; border-radius: 12px; background: #000;
    box-shadow: inset 0 0 0 2px rgba(0,0,0,.06);
  }
  .alert {
    display:none; background:#ffe8ea; color:#92001c; border:1px solid #ffb7c1;
    padding:8px 12px; border-radius:10px; font-weight:700; text-align:center;
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Status (shows if Colors.mp4 is missing or fails to load) -->
    <div class="row"><div id="status" class="alert"></div></div>

    <!-- Keep native controls for quick sanity checks -->
    <video id="vid" src="Colors.mp4" controls playsinline></video>

    <!-- Transport + simple speed + volume -->
    <div class="row">
      <button id="back5" class="btn" title="Back 5s">⟵ 5s</button>
      <button id="play"  class="btn" title="Play/Pause (Space)">▶ Play</button>
      <button id="pause" class="btn" title="Pause">⏸ Pause</button>
      <button id="fwd5"  class="btn" title="Forward 5s">5s ⟶</button>

      <span class="small" style="margin-left:12px">Speed</span>
      <button id="slowBtn" class="btn ghost" title="0.85×">Slow</button>
      <button id="fastBtn" class="btn ghost" title="1.25×">Fast</button>
      <span id="speedLabel" class="chip">1.00×</span>

      <span class="small" style="margin-left:12px">Volume</span>
      <input id="volume" type="range" min="0" max="1" step="0.01" value="1"/>
    </div>

    <!-- Fun FX (bold, obvious) + FX On/Off -->
    <div class="row">
      <button id="fxToggle" class="btn pink">FX: On</button>
      <button data-fx="none"      class="btn ghost">None</button>
      <button data-fx="chipmunk"  class="btn">Chipmunk</button>
      <button data-fx="deep"      class="btn">Deep</button>
      <button data-fx="robot"     class="btn">Robot</button>
      <button data-fx="telephone" class="btn">Telephone</button>
      <button data-fx="echo"      class="btn">Echo</button>
      <button data-fx="cave"      class="btn">Cave</button>
      <button data-fx="alien"     class="btn">Alien</button>
    </div>
  </div>

<script>
(async function(){
  const DEFAULT_SRC = 'Colors.mp4'; // exact case for GitHub Pages
  const vid = document.getElementById('vid');
  const statusEl = document.getElementById('status');

  // Status helper
  function showStatus(msg){ statusEl.innerHTML = msg; statusEl.style.display = 'block'; }
  function hideStatus(){ statusEl.style.display = 'none'; }

  // Show error if video fails to load
  vid.addEventListener('error', () => {
    showStatus(`Couldn’t load <b>${DEFAULT_SRC}</b>.<br>
      Make sure it’s in the same folder and the name matches <b>exactly</b> (case-sensitive).`);
  });

  // --- Transport & simple speed ---
  const playBtn  = document.getElementById('play');
  const pauseBtn = document.getElementById('pause');
  const back5    = document.getElementById('back5');
  const fwd5     = document.getElementById('fwd5');
  const slowBtn  = document.getElementById('slowBtn');
  const fastBtn  = document.getElementById('fastBtn');
  const speedLabel = document.getElementById('speedLabel');
  const volume   = document.getElementById('volume');

  function setSpeed(v){
    const clamped = Math.max(0.25, Math.min(2.0, v));
    vid.playbackRate = clamped;
    speedLabel.textContent = clamped.toFixed(2) + '×';
  }
  playBtn.addEventListener('click', async () => { hideStatus(); try{ await vid.play(); }catch{} });
  pauseBtn.addEventListener('click', () => vid.pause());
  back5.addEventListener('click', () => { vid.currentTime = Math.max(0, vid.currentTime - 5); });
  fwd5.addEventListener('click',  () => { vid.currentTime = Math.min((vid.duration||1e9)-0.001, vid.currentTime + 5); });
  slowBtn.addEventListener('click', () => setSpeed(0.85));
  fastBtn.addEventListener('click', () => setSpeed(1.25));
  setSpeed(1.00);

  window.addEventListener('keydown', (e) => {
    if (e.code === 'Space'){ e.preventDefault(); if (vid.paused) playBtn.click(); else pauseBtn.click(); }
    if (e.key === 'ArrowLeft')  back5.click();
    if (e.key === 'ArrowRight') fwd5.click();
  });

  // Volume: if FX graph isn’t active yet, control element volume; otherwise control master gain
  let master = null;
  function setVolume(v){
    if (master) master.gain.value = Math.max(0, Math.min(1, v));
    else vid.volume = Math.max(0, Math.min(1, v));
  }
  volume.addEventListener('input', (e)=> setVolume(parseFloat(e.target.value)));

  // --- WebAudio FX (refactored for strong wet/dry) ---
  const fxToggle = document.getElementById('fxToggle');
  const fxButtons = document.querySelectorAll('[data-fx]');
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let ctx, srcNode, dryGain, directWet, echoMix, reverbMix, hp, bp, lp, shaper, delay, fb, convolver, trem, lfo, lfoGain;
  let fxEnabled = true;

  function makeDistortion(amount=0){
    const k = amount, n = 44100, curve = new Float32Array(n), deg = Math.PI/180;
    for (let i=0;i<n;i++){ const x = i*2/n - 1; curve[i]=(3+k)*x*20*deg/(Math.PI + k*Math.abs(x)); }
    return curve;
  }

  async function ensureAudioGraph(){
    if (ctx) return;
    ctx = new AudioCtx();
    await ctx.resume().catch(()=>{});

    // Nodes
    srcNode  = ctx.createMediaElementSource(vid);
    dryGain  = ctx.createGain();  dryGain.gain.value = 1.0;    // clean path
    directWet= ctx.createGain();  directWet.gain.value = 0.0;  // processed (no echo/reverb) to master
    echoMix  = ctx.createGain();  echoMix.gain.value = 0.0;    // echo to master
    reverbMix= ctx.createGain();  reverbMix.gain.value = 0.0;  // reverb to master
    master   = ctx.createGain();  master.gain.value = parseFloat(volume.value);

    // Processing chain
    trem = ctx.createGain(); trem.gain.value = 1.0;
    lfo  = ctx.createOscillator(); lfo.type='sine'; lfo.frequency.value=0;
    lfoGain = ctx.createGain(); lfoGain.gain.value=0;
    lfo.connect(lfoGain).connect(trem.gain); lfo.start();

    hp = ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=20;   hp.Q.value=0.7;
    bp = ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1000; bp.Q.value=0.1;
    lp = ctx.createBiquadFilter(); lp.type='lowpass';  lp.frequency.value=20000;lp.Q.value=0.7;

    shaper = ctx.createWaveShaper(); shaper.curve = makeDistortion(0); shaper.oversample='4x';

    delay = ctx.createDelay(2.0); delay.delayTime.value=0.22;
    fb    = ctx.createGain();     fb.gain.value=0.32;
    delay.connect(fb).connect(delay); // feedback

    convolver = ctx.createConvolver();
    // light “cave” impulse
    (function makeImpulse(seconds=2.0, decay=2.2){
      const rate=ctx.sampleRate,len=rate*seconds,ir=ctx.createBuffer(2,len,rate);
      for(let c=0;c<2;c++){ const ch=ir.getChannelData(c);
        for(let i=0;i<len;i++){ ch[i]=(Math.random()*2-1)*Math.pow(1-i/len,decay); } }
      convolver.buffer = ir;
    })();

    // Wiring
    srcNode.connect(dryGain);          // dry -> master
    srcNode.connect(trem);             // wet path start
    trem.connect(hp).connect(bp).connect(lp).connect(shaper);
    shaper.connect(directWet);         // processed direct
    shaper.connect(delay).connect(echoMix); // echo
    shaper.connect(convolver);         // reverb
    convolver.connect(reverbMix);

    // Mixdown
    dryGain.connect(master);
    directWet.connect(master);
    echoMix.connect(master);
    reverbMix.connect(master);
    master.connect(ctx.destination);

    // Avoid double audio
    vid.muted = true;
  }

  function resetFX(){
    if (!ctx) return;
    // Neutral filters
    hp.frequency.value=20; hp.Q.value=0.7;
    bp.frequency.value=1000; bp.Q.value=0.1;
    lp.frequency.value=20000; lp.Q.value=0.7;
    // No distortion
    shaper.curve = makeDistortion(0);
    // Mixes off
    directWet.gain.value = 0.0;
    echoMix.gain.value   = 0.0;
    reverbMix.gain.value = 0.0;
    // Tremolo off
    lfo.frequency.value = 0;
    lfoGain.gain.value  = 0;
    trem.gain.value     = 1.0;
    // Dry back to full if FX disabled
    if (!fxEnabled) dryGain.gain.value = 1.0;
  }

  function setFX(name){
    if (!ctx) return;
    resetFX();

    // By default, make effects obvious: drop dry unless stated
    dryGain.gain.value = fxEnabled ? 0.0 : 1.0;

    switch(name){
      case 'none':
        // FX off path: just dry
        dryGain.gain.value = 1.0;
        break;

      case 'telephone': // narrow band, clear
        directWet.gain.value = 1.0;
        hp.frequency.value = 350; lp.frequency.value = 3300; bp.frequency.value = 1200; bp.Q.value = 0.8;
        break;

      case 'robot': // crunchy + band-limit + tiny echo
        directWet.gain.value = 1.0;
        hp.frequency.value = 180; lp.frequency.value = 3800; bp.frequency.value = 1200; bp.Q.value = 1.2;
        shaper.curve = makeDistortion(75);
        echoMix.gain.value = 0.08;
        break;

      case 'cave': // big reverb, small echo, keep a bit of dry so words are readable
        dryGain.gain.value = 0.2;
        directWet.gain.value = 0.1;
        reverbMix.gain.value = 0.45;
        echoMix.gain.value   = 0.10;
        delay.delayTime.value= 0.12;
        break;

      case 'echo': // fun echo
        dryGain.gain.value = 0.6;
        directWet.gain.value = 0.2;
        echoMix.gain.value   = 0.30;
        delay.delayTime.value= 0.22; fb.gain.value=0.32;
        break;

      case 'alien': // tremolo wobble + bandpass
        dryGain.gain.value = 0.2;
        directWet.gain.value = 0.9;
        bp.frequency.value = 900; bp.Q.value = 0.9;
        lfo.frequency.value = 35; lfoGain.gain.value = 0.5; // depth
        break;

      case 'chipmunk': // playful: speed up = higher pitch
        directWet.gain.value = 1.0;
        hp.frequency.value = 120; lp.frequency.value = 18000;
        setSpeed(1.25);
        break;

      case 'deep': // slower = deeper voice
        directWet.gain.value = 1.0;
        lp.frequency.value = 4800;
        setSpeed(0.85);
        break;
    }

    // Update button styles
    fxButtons.forEach(b => b.classList.toggle('ghost', b.dataset.fx !== name));
  }

  // Toggle FX master on/off (ramps dry up/down)
  function updateFxToggleButton(){
    fxToggle.textContent = fxEnabled ? 'FX: On' : 'FX: Off';
    fxToggle.classList.toggle('pink', fxEnabled);
    fxToggle.classList.toggle('ghost', !fxEnabled);
  }
  fxToggle.addEventListener('click', async () => {
    await ensureAudioGraph();
    fxEnabled = !fxEnabled;
    updateFxToggleButton();
    if (fxEnabled){
      // turn effects back on using last selected preset (or default to robot)
      const active = document.querySelector('[data-fx]:not(.ghost)')?.dataset.fx || 'robot';
      setFX(active);
    } else {
      // pure dry
      resetFX();
      dryGain.gain.value = 1.0;
    }
  });
  updateFxToggleButton();

  // Preset buttons
  fxButtons.forEach(b => b.addEventListener('click', async (ev) => {
    await ensureAudioGraph();
    fxEnabled = true; updateFxToggleButton();
    setFX(ev.currentTarget.dataset.fx);
  }));
  // default selection
  // (No preset selected at load; user picks one. If you want a default, uncomment:)
  // await ensureAudioGraph(); setFX('robot');

  // Start AudioContext on first user interaction (iOS)
  ['click','touchstart','keydown'].forEach(ev => document.addEventListener(ev, async ()=> {
    if (!ctx) return;
    await ctx.resume().catch(()=>{});
  }, { once:true }));

  // Initialize volume display
  setVolume(parseFloat(volume.value));
})();
</script>
</body>
</html>
